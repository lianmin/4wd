<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{title || '4wd app'}}</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="/javascripts/vue.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-size: 4rem;
    }

    button {
      width: 15rem;
      height: 15rem;
      font-size: 7rem;
      border: 1px solid red;
      border-radius: 7.5rem;
    }
  </style>
</head>
<body>

<div id="app">
  <button @touchstart="forward" @touchend="stop">前</button>
  <button @touchstart="backward" @touchend="stop">后</button>
  <button @touchstart="left" @touchend="stop">左</button>
  <button @touchstart="right" @touchend="stop">右</button>

  <p>alpha: {{alpha}}</p>
  <p>beta: {{beta}}</p>
  <p>gamma: {{gamma}}</p>
  <p>msg: {{msg}}</p>
</div>

<script>
  new Vue({
    el: '#app',
    data: function () {
      return {
        socket: io(),
        alpha: 10,
        beta: 0,
        gamma: 0,
      }
    },
    computed: {
      msg (){
        return `orientation:${alpha}`
      }
    },
    methods: {
      forward() {
        this.socket.emit('forward')
      },
      backward(){
        this.socket.emit('backward')
      },
      left(){
        this.socket.emit('left')
      },
      right(){
        this.socket.emit('right')
      },
      stop(){
        this.socket.emit('stop')
      }
    },
    created: function () {
      let _this = this

      window.addEventListener('deviceorientation', ({alpha, beta, gamma}) => {
        _this.alpha = parseInt(alpha)
        _this.beta = parseInt(beta)
        _this.gamma = parseInt(gamma)

        if (_this.timer) {
          return
        }

        _this.timer = window.setTimeout(() => {
          _this.socket.emit('orient', `${_this.alpha},${_this.beta},${_this.gamma}`)

          if (gamma < -30) {
            // 启动监听
            if (beta > 30) {
              this.socket.emit('right')
            } else if (beta < -30) {
              this.socket.emit('left')
            }
          }

          _this.timer = null
        }, 500)
      }, false);
    }
  })
</script>
</body>
</html>

